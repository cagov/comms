<!doctype html>
<html>
  <head>
    <title>Covid19.ca.gov reports from Was this page Helpful widget</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

  </head>
  <body>

    <h1>Was this page helpful comments</h1>
    Start: <vaadin-date-picker value="2020-07-21" placeholder="Start date" id="startPicker"></vaadin-date-picker>
    End: <vaadin-date-picker value="2020-07-22" placeholder="End date" id="endPicker"></vaadin-date-picker>
    URL Contains: <vaadin-text-field placeholder="url" value="" id="urlfield"></vaadin-text-field>

    <div class="js-results"></div>

    <script type="module" src="index.js"></script>
    <script>
      const startPicker = document.querySelector('#startPicker');
      const endPicker = document.querySelector('#endPicker');
      const urlField = document.querySelector('#urlfield');
      const resultsEl = document.querySelector('.js-results');

      let startDateVal = new Date(startPicker.getAttribute("value")).getTime();
      let endDateVal = new Date(endPicker.getAttribute("value")).getTime();
      let urlPiece = urlField.getAttribute('value');

      function buildURL() {
        return `https://fa-go-alph-d-001.azurewebsites.net/WasHelpfulData/${startDateVal}/${endDateVal}?url=${encodeURIComponent(urlPiece)}`;
      }
      
      function getData() {
        fetch(buildURL())
          .then(response => response.json())
          .then(data => {
            let html = resultDisplay(data);
            resultsEl.innerHTML = html;
          });
      }
      getData()

      customElements.whenDefined('vaadin-date-picker').then(function() {
        startPicker.addEventListener('change', function(event) {
          startDateVal = event.target.value;
          getData()
        });
        endPicker.addEventListener('change', function(event) {
          endDateVal = event.target.value;
          getData()
        });
        urlField.addEventListener('change', function(event) {
          urlPiece = event.target.value;
          getData()
        });
      });

      function resultDisplay(data) {
        let urlMap = new Map();
        data.forEach(item => {
          let comments = (urlMap.get(item.url) ? urlMap.get(item.url) : []);
          comments.push(item);
          urlMap.set(item.url,comments);
        })
        let lists = '';
        urlMap.forEach(comments => {
          lists += `<h2><a href="${comments[0].url}">${comments[0].url}</a></h2>
            <ul>
              ${comments.map((item) => {
                return `<li>Helpful? ${item.helpful}<br>
                  Comment: ${item.comments}</li>`;
              }).join(' ')}
            </ul>`;
        });

        return `<ul>
          ${lists}
        </ul>`
      }
    </script>

  </body>
</html>